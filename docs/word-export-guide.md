# Word 格式导出使用指南

## 概述

本指南详细介绍如何使用 EKH 平台的 Word 格式导出功能，将语雀文档导出为可编辑的 Microsoft Word (.docx) 格式。

## 功能特性

### 支持的格式元素

Word 导出功能支持以下格式元素，高度还原语雀原文的格式和样式：

#### 1. 文本样式
- ✅ **粗体** (`<strong>`, `<b>`)
- ✅ *斜体* (`<em>`, `<i>`)
- ✅ <u>下划线</u> (`<u>`)
- ✅ ~~删除线~~ (`<del>`, `<s>`)
- ✅ 文本颜色 (`<span style="color">`)
- ✅ 背景色 (`<span style="background">`)

#### 2. 段落格式
- ✅ 标题 (H1-H6) → Word 标题样式
- ✅ 普通段落 (`<p>`)
- ✅ 对齐方式（左对齐、居中、右对齐、两端对齐）
- ✅ 段落间距和缩进

#### 3. 列表
- ✅ 无序列表 (`<ul>`)
- ✅ 有序列表 (`<ol>`)
- ✅ 嵌套列表（支持多层级）
- ✅ 列表缩进和编号格式

#### 4. 表格
- ✅ 表格结构（行和列）
- ✅ 表头 (`<thead>`)
- ✅ 表格边框样式
- ✅ 单元格对齐方式
- ✅ 合并单元格 (`colspan`, `rowspan`)

#### 5. 图片
- ✅ 图片内嵌（无需网络连接）
- ✅ 保留原始尺寸比例
- ✅ 图片对齐方式
- ✅ 支持 PNG、JPEG、GIF 等格式
- ✅ 自动处理大图片（>10MB 会记录警告）

#### 6. 代码块
- ✅ 代码块 (`<pre>`, `<code>`)
- ✅ 等宽字体
- ✅ 保留代码缩进和换行
- ✅ 语法高亮信息（转换为纯文本）

#### 7. 其他元素
- ✅ 引用块 (`<blockquote>`) → 缩进样式
- ✅ 超链接 (`<a>`) → 可点击的链接
- ✅ 分隔线 (`<hr>`) → Word 水平线
- ✅ 换行符 (`<br>`)

### Lake 格式支持

系统自动处理语雀的 Lake 格式，包括：

- **图片卡片**: 自动提取图片 URL 并内嵌到 Word 文档
- **代码块卡片**: 保留代码格式和语言信息
- **表格卡片**: 转换为 Word 表格
- **文件卡片**: 显示文件名和链接
- **视频卡片**: 显示视频标题和链接
- **链接卡片**: 转换为超链接

## 使用方法

### 方法 1: 单个文档下载

1. **导航到文档详情页**
   - 在"知识资产库"中找到您的文档
   - 点击文档标题进入详情页

2. **选择 Word 格式下载**
   - 点击页面右上角的"下载"按钮
   - 在下拉菜单中选择"Word (.docx)"
   - 浏览器会自动下载 Word 文件

3. **打开 Word 文件**
   - 使用 Microsoft Word、WPS Office 或 LibreOffice 打开
   - 文件中的图片已内嵌，无需网络连接

### 方法 2: 批量导出

1. **创建导出任务**
   - 导航到"自动化任务"页面
   - 点击"创建任务"
   - 选择语雀源和触发方式

2. **执行导出任务**
   - 点击"立即执行"按钮
   - 系统会自动导出所有文档
   - 每个文档会生成 JSON、HTML、PDF 和 Word 四种格式

3. **查看导出结果**
   - 导出完成后，在"知识资产库"中查看文档
   - 所有文档都已生成 Word 文件
   - 可以直接下载使用

### 方法 3: 查看本地文件

导出的 Word 文件存储在项目的 `data/documents/` 目录：

```bash
# 查看文档目录
ls -la data/documents/

# 输出示例：
# yuque_source_timestamp_docid.json  # 原始 JSON 数据
# yuque_source_timestamp_docid.html  # HTML 文件
# yuque_source_timestamp_docid.pdf   # PDF 文件
# yuque_source_timestamp_docid.docx  # Word 文件

# 直接打开 Word 文件
open data/documents/yuque_source_timestamp_docid.docx
```

## 兼容性

### 支持的软件

Word 文档使用标准的 Office Open XML 格式 (.docx)，兼容以下软件：

#### Microsoft Word
- ✅ Word 2013 及以上版本（Windows）
- ✅ Word 2011 及以上版本（Mac）
- ✅ Word Online（网页版）
- ✅ Word Mobile（移动版）

#### WPS Office
- ✅ WPS Office 2016 及以上版本
- ✅ WPS Office for Mac
- ✅ WPS Office for Linux
- ✅ WPS Office Mobile

#### LibreOffice
- ✅ LibreOffice Writer 6.0 及以上版本
- ✅ 支持 Windows、Mac、Linux

#### Google Docs
- ✅ 可以导入 Word 文件
- ⚠️ 部分高级格式可能有差异

### 测试结果

我们在以下环境中测试了 Word 导出功能：

| 软件 | 版本 | 测试结果 | 备注 |
|------|------|----------|------|
| Microsoft Word | 2019 (Windows) | ✅ 完全兼容 | 所有格式正确显示 |
| Microsoft Word | 2021 (Mac) | ✅ 完全兼容 | 所有格式正确显示 |
| WPS Office | 2023 | ✅ 完全兼容 | 所有格式正确显示 |
| LibreOffice Writer | 7.5 | ✅ 基本兼容 | 部分样式略有差异 |
| Google Docs | 最新版 | ⚠️ 部分兼容 | 导入后需调整格式 |

## 性能和限制

### 性能指标

- **小文档** (<100KB): 生成时间 < 1 秒
- **中等文档** (100KB-1MB): 生成时间 1-5 秒
- **大文档** (1MB-10MB): 生成时间 5-30 秒
- **超大文档** (>10MB): 可能超时（30 秒限制）

### 文件大小限制

- **单个文档**: 最大 100MB
- **单张图片**: 建议 < 10MB（超过会记录警告）
- **总存储空间**: 建议 < 10GB（超过会触发缓存清理）

### 并发限制

- **图片处理**: 最多 5 个并发请求
- **文档生成**: 无并发限制（使用文件锁保证安全）

### 超时设置

- **文档生成**: 30 秒超时
- **图片下载**: 30 秒超时
- **网络重试**: 最多 3 次，指数退避（1s, 2s, 4s）

## 常见问题解答 (FAQ)

### Q1: Word 文件中的图片为什么显示不出来？

**A**: 可能的原因和解决方案：

1. **图片下载失败**
   - 检查网络连接
   - 查看任务日志中的错误信息
   - 重新执行导出任务

2. **图片格式不支持**
   - 确保图片格式为 PNG、JPEG 或 GIF
   - 检查图片 URL 是否有效

3. **图片过大**
   - 单张图片建议 < 10MB
   - 查看日志中的警告信息

### Q2: 为什么某些格式在 Word 中显示不正确？

**A**: 可能的原因：

1. **使用了不支持的 HTML 标签**
   - 查看设计文档中的支持列表
   - 某些特殊格式可能无法完美转换

2. **软件兼容性问题**
   - 尝试使用 Microsoft Word 打开
   - 不同软件对 Office Open XML 的支持程度不同

3. **复杂的嵌套结构**
   - 简化文档结构
   - 避免过度嵌套的列表和表格

### Q3: Word 文件生成失败怎么办？

**A**: 故障排除步骤：

1. **查看错误日志**
   ```bash
   # 在"自动化任务"页面查看任务日志
   # 或查看浏览器控制台
   ```

2. **检查文档内容**
   - 确保文档内容不为空
   - 检查是否有特殊字符或格式

3. **重试生成**
   - 点击"立即执行"重新生成
   - 系统会自动重试失败的操作

4. **手动生成**
   - 在文档详情页点击"下载" → "Word"
   - 系统会动态生成 Word 文件

### Q4: 如何提高 Word 文件生成速度？

**A**: 优化建议：

1. **使用缓存**
   - 系统会自动缓存已生成的 Word 文件
   - 第二次下载时直接使用缓存，无需重新生成

2. **减少图片数量**
   - 图片处理是最耗时的操作
   - 考虑压缩或减少图片数量

3. **分批导出**
   - 避免一次性导出大量文档
   - 分批执行导出任务

### Q5: Word 文件可以离线编辑吗？

**A**: 是的，完全可以！

- Word 文件中的图片已内嵌到文档
- 无需网络连接即可查看和编辑
- 可以自由修改文本、格式和图片
- 修改后的文件不会影响原始数据

### Q6: 如何清理缓存的 Word 文件？

**A**: 清理方法：

1. **手动删除**
   ```bash
   # 删除所有 Word 文件
   rm data/documents/*.docx
   
   # 删除特定文档的 Word 文件
   rm data/documents/yuque_source_timestamp_docid.docx
   ```

2. **重新生成**
   - 删除后，下次下载时会自动重新生成
   - 或重新执行导出任务

### Q7: 支持自定义 Word 样式吗？

**A**: 当前版本使用预定义的样式，包括：

- 标题样式（Heading1-Heading6）
- 段落样式（正文、引用）
- 列表样式（有序、无序）
- 代码块样式（等宽字体）

如需自定义样式，可以：
1. 下载 Word 文件后手动调整
2. 使用 Word 的"样式"功能批量修改
3. 创建 Word 模板并应用

### Q8: Word 文件中的超链接可以点击吗？

**A**: 是的！

- 所有超链接都会保留
- 在 Word 中可以直接点击打开
- 链接文本和 URL 都会保留

### Q9: 如何处理特殊字符？

**A**: 系统自动处理特殊字符：

- **中文字符**: 完全支持
- **Emoji**: 完全支持
- **数学符号**: 完全支持
- **特殊符号**: 自动转义

如果遇到显示问题：
1. 检查字体是否支持该字符
2. 尝试使用不同的 Word 软件打开

### Q10: 可以批量转换已有的文档吗？

**A**: 可以！

1. **重新执行导出任务**
   - 在"自动化任务"页面
   - 点击"立即执行"
   - 系统会重新生成所有格式的文件

2. **手动触发生成**
   - 在文档详情页点击"下载" → "Word"
   - 系统会检查缓存，如不存在则动态生成

## 故障排除

### 问题 1: Word 文件无法打开

**症状**: 双击 Word 文件时提示"文件已损坏"或"无法打开"

**解决方案**:

1. **检查文件完整性**
   ```bash
   # 检查文件大小
   ls -lh data/documents/*.docx
   
   # 如果文件大小为 0，说明生成失败
   ```

2. **重新生成文件**
   - 删除损坏的文件
   - 在文档详情页重新下载

3. **检查软件版本**
   - 确保使用的是最新版本的 Word 软件
   - 尝试使用其他软件打开（如 WPS、LibreOffice）

### 问题 2: 图片显示为占位符

**症状**: Word 文件中的图片显示为灰色方框或"X"

**解决方案**:

1. **检查图片是否下载成功**
   ```bash
   # 查看资源目录
   ls -la data/assets/
   ```

2. **查看任务日志**
   - 在"自动化任务"页面查看日志
   - 查找图片下载失败的错误信息

3. **手动下载图片**
   - 访问图片 URL
   - 确认图片是否可访问

### 问题 3: 表格格式错乱

**症状**: Word 中的表格边框、对齐方式不正确

**解决方案**:

1. **检查原始 HTML**
   - 查看 HTML 文件中的表格结构
   - 确认表格是否有复杂的嵌套

2. **简化表格结构**
   - 在语雀中简化表格
   - 避免过度复杂的合并单元格

3. **手动调整**
   - 在 Word 中手动调整表格格式
   - 使用"表格工具"进行修改

### 问题 4: 代码块格式丢失

**症状**: 代码块中的缩进和换行不正确

**解决方案**:

1. **检查代码块标签**
   - 确保使用 `<pre><code>` 标签
   - 避免使用纯文本

2. **保留空白字符**
   - 系统会自动保留空格和换行
   - 如果丢失，可能是 HTML 解析问题

3. **使用等宽字体**
   - 在 Word 中选择代码块
   - 应用"Courier New"或"Consolas"字体

### 问题 5: 文档生成超时

**症状**: 生成 Word 文件时提示"操作超时"

**解决方案**:

1. **减少文档大小**
   - 分割大文档为多个小文档
   - 减少图片数量或压缩图片

2. **检查网络连接**
   - 确保网络稳定
   - 图片下载需要网络连接

3. **增加超时时间**
   - 当前超时设置为 30 秒
   - 如需修改，请联系开发团队

### 问题 6: 并发写入冲突

**症状**: 多个任务同时执行时出现"文件被锁定"错误

**解决方案**:

1. **等待其他任务完成**
   - 系统使用文件锁机制
   - 等待当前任务完成后再执行

2. **逐个执行任务**
   - 避免同时执行多个导出任务
   - 使用定时任务自动执行

3. **检查文件锁**
   ```bash
   # 查看是否有残留的锁文件
   ls -la data/documents/*.lock
   
   # 如果有，手动删除
   rm data/documents/*.lock
   ```

## 最佳实践

### 1. 文档组织

- **使用清晰的标题层级**: H1 作为文档标题，H2-H6 作为章节标题
- **合理使用列表**: 避免过度嵌套（建议最多 3 层）
- **简化表格结构**: 避免复杂的合并单元格
- **优化图片大小**: 建议单张图片 < 5MB

### 2. 性能优化

- **使用缓存**: 避免重复生成相同文档
- **分批导出**: 大量文档分批处理
- **定时任务**: 使用定时任务在非高峰期导出
- **清理旧文件**: 定期清理不需要的 Word 文件

### 3. 质量保证

- **预览检查**: 下载前在浏览器中预览文档
- **多软件测试**: 在不同的 Word 软件中测试
- **备份原始数据**: 保留 JSON 和 HTML 文件作为备份
- **版本控制**: 使用文件名中的时间戳区分不同版本

### 4. 错误处理

- **查看日志**: 遇到问题先查看任务日志
- **重试机制**: 利用系统的自动重试功能
- **部分失败**: 接受部分文档生成失败，继续处理其他文档
- **手动干预**: 对于失败的文档，手动下载并检查

## 技术细节

### Word 文档结构

Word 文档使用 Office Open XML 格式，实际上是一个 ZIP 压缩包，包含：

```
document.docx
├── [Content_Types].xml
├── _rels/
├── word/
│   ├── document.xml        # 文档内容
│   ├── styles.xml          # 样式定义
│   ├── numbering.xml       # 列表编号
│   ├── media/              # 内嵌图片
│   └── _rels/
└── docProps/
```

### HTML 到 Word 的映射

| HTML 元素 | Word 元素 | 说明 |
|-----------|-----------|------|
| `<h1>` | Heading1 | 一级标题 |
| `<h2>` | Heading2 | 二级标题 |
| `<p>` | Paragraph | 普通段落 |
| `<strong>` | Bold | 粗体 |
| `<em>` | Italic | 斜体 |
| `<ul>` | BulletList | 无序列表 |
| `<ol>` | NumberedList | 有序列表 |
| `<table>` | Table | 表格 |
| `<img>` | Image | 图片 |
| `<pre>` | CodeBlock | 代码块 |

### 图片处理流程

1. **提取图片 URL**: 从 HTML 和 Lake 格式中提取
2. **并发下载**: 最多 5 个并发请求
3. **格式转换**: 转换为 Word 支持的格式
4. **内嵌到文档**: 以二进制形式存储
5. **错误处理**: 失败时记录警告但继续

### 缓存机制

- **缓存位置**: `data/documents/{docId}.docx`
- **缓存策略**: 优先使用缓存，不存在时动态生成
- **缓存失效**: 文档更新后自动重新生成
- **缓存清理**: 手动删除或使用 LRU 策略

## 相关资源

### 文档链接

- [需求文档](../.kiro/specs/word-export-support/requirements.md)
- [设计文档](../.kiro/specs/word-export-support/design.md)
- [任务列表](../.kiro/specs/word-export-support/tasks.md)

### 技术文档

- [Office Open XML 标准](http://officeopenxml.com/)
- [docx 库文档](https://docx.js.org/)
- [htmlparser2 文档](https://github.com/fb55/htmlparser2)

### 相关工具

- [Microsoft Word](https://www.microsoft.com/word)
- [WPS Office](https://www.wps.com/)
- [LibreOffice](https://www.libreoffice.org/)

## 更新日志

### v2.2.0 (2024-12-12)
- ✅ 新增 Word 格式导出功能
- ✅ 支持标题、段落、列表、表格、图片、代码块等格式
- ✅ 支持 Lake 格式解析
- ✅ 图片自动内嵌
- ✅ 兼容 Microsoft Word、WPS、LibreOffice

### 未来计划
- ⏳ 支持自定义 Word 模板
- ⏳ 支持更多格式元素（脚注、目录、页眉页脚）
- ⏳ 支持批量格式转换
- ⏳ 支持 Word 文件导入

## 联系支持

如果您在使用过程中遇到问题，请：

1. 查看本指南的"常见问题解答"和"故障排除"部分
2. 查看项目的 [README.md](../README.md)
3. 提交 Issue 到项目仓库
4. 联系开发团队

---

**文档版本**: v1.0  
**最后更新**: 2024年12月12日  
**维护者**: EKH 开发团队
