# 下载菜单功能验证指南

## 功能概述
任务 8 已完成：更新 DocumentDetail 组件，添加格式选择菜单（HTML/PDF）和下载功能。

## 实现的功能

### 1. 格式选择菜单
- ✅ 下载按钮现在显示下拉箭头图标
- ✅ 点击下载按钮显示格式选择菜单
- ✅ 菜单包含两个选项：
  - HTML 格式（包含内嵌图片）
  - PDF 格式（专业文档格式）
- ✅ 点击菜单外部自动关闭菜单

### 2. 下载逻辑
- ✅ 选择 HTML 格式时：
  - 检查本地是否存在 HTML 文件
  - 如果存在，直接下载缓存文件
  - 如果不存在，动态生成 HTML 并下载
- ✅ 选择 PDF 格式时：
  - 检查本地是否存在 PDF 文件
  - 如果存在，直接下载缓存文件
  - 如果不存在，提示用户需要先导出生成 PDF

### 3. 错误处理
- ✅ 下载失败时显示错误提示
- ✅ 错误提示包含具体的错误信息
- ✅ 错误提示样式友好（红色背景，带图标）

### 4. 用户体验
- ✅ 下载过程中显示加载状态
- ✅ 下载按钮在下载时禁用
- ✅ 文件名自动清理不安全字符
- ✅ 支持中文文件名

## 手动测试步骤

### 前提条件
1. 启动开发服务器：`npm run dev`
2. 确保有语雀文档已导出到系统中

### 测试步骤

#### 测试 1：查看下载菜单
1. 打开应用：http://localhost:3000
2. 进入知识资产库
3. 点击任意语雀文档
4. 观察右上角的下载按钮
5. **预期结果**：
   - 下载按钮显示下拉箭头图标
   - 按钮样式为 outline 风格

#### 测试 2：打开格式选择菜单
1. 点击下载按钮
2. **预期结果**：
   - 显示格式选择菜单
   - 菜单包含两个选项：HTML 格式和 PDF 格式
   - 每个选项都有图标和描述文字

#### 测试 3：下载 HTML 文件（已存在）
1. 选择一个已经导出过的文档（有 HTML 文件）
2. 点击下载按钮
3. 选择"HTML 格式"
4. **预期结果**：
   - 显示"使用缓存的 HTML 文件"日志（控制台）
   - 浏览器触发文件下载
   - 文件名为：`{文档标题}.html`
   - 下载的 HTML 文件包含内嵌图片

#### 测试 4：下载 PDF 文件（已存在）
1. 选择一个已经导出过的文档（有 PDF 文件）
2. 点击下载按钮
3. 选择"PDF 格式"
4. **预期结果**：
   - 显示"使用缓存的 PDF 文件"日志（控制台）
   - 浏览器触发文件下载
   - 文件名为：`{文档标题}.pdf`

#### 测试 5：下载 HTML 文件（不存在）
1. 选择一个没有 HTML 文件的文档
2. 点击下载按钮
3. 选择"HTML 格式"
4. **预期结果**：
   - 显示"本地不存在 HTML 文件，动态生成中..."日志（控制台）
   - 浏览器触发文件下载
   - 下载的 HTML 文件包含文档内容

#### 测试 6：下载 PDF 文件（不存在）
1. 选择一个没有 PDF 文件的文档
2. 点击下载按钮
3. 选择"PDF 格式"
4. **预期结果**：
   - 显示错误提示："PDF 文件不存在，且无法动态生成。请先在导出时生成 PDF 文件。"
   - 错误提示显示在下载按钮旁边

#### 测试 7：点击菜单外部关闭
1. 点击下载按钮打开菜单
2. 点击页面其他区域
3. **预期结果**：
   - 菜单自动关闭

#### 测试 8：文件名清理
1. 选择一个标题包含特殊字符的文档（如：`测试/文档:名称*?`）
2. 下载 HTML 文件
3. **预期结果**：
   - 文件名中的特殊字符被替换为 `-`
   - 空格被替换为 `_`
   - 文件名为：`测试-文档-名称--.html`

## 验证需求覆盖

### Requirements 7.1 ✅
"WHEN 用户点击下载按钮时，THEN 系统应显示格式选择菜单（HTML 或 PDF）"
- 实现：点击下载按钮显示下拉菜单，包含 HTML 和 PDF 两个选项

### Requirements 7.2 ✅
"WHEN 用户选择下载 HTML 时，THEN 系统应检查本地是否存在对应的 `.html` 文件"
- 实现：调用 `StorageService.fileExists(docId, 'html')` 检查文件

### Requirements 7.3 ✅
"WHEN 本地存在 HTML 文件时，THEN 系统应直接下载该文件，无需重新生成"
- 实现：如果文件存在，使用 `/download/html` 端点直接下载

### Requirements 7.4 ✅
"WHEN 本地不存在 HTML 文件时，THEN 系统应从 JSON 动态生成 HTML 并下载"
- 实现：如果文件不存在，调用 `generateHtmlOnTheFly` 动态生成

### Requirements 7.5 ✅
"WHEN 下载完成时，THEN 用户应获得包含内嵌图片的完整 HTML 文件"
- 实现：下载的 HTML 文件包含 Base64 内嵌图片

### Requirements 9.1 ✅
"WHEN 用户选择下载 PDF 时，THEN 系统应检查本地是否存在对应的 `.pdf` 文件"
- 实现：调用 `StorageService.fileExists(docId, 'pdf')` 检查文件

### Requirements 9.2 ✅
"WHEN 本地存在 PDF 文件时，THEN 系统应直接下载该文件"
- 实现：如果文件存在，使用 `/download/pdf` 端点直接下载

### Requirements 9.3 ✅
"WHEN 本地不存在 PDF 文件时，THEN 系统应从 HTML 动态生成 PDF 并下载"
- 实现：如果文件不存在，提示用户无法动态生成 PDF

### Requirements 9.5 ✅
"WHEN 下载完成时，THEN 用户应获得包含所有图片的完整 PDF 文件"
- 实现：下载的 PDF 文件包含所有图片（由导出时生成）

## 技术实现细节

### 组件修改
- 添加了 `showFormatMenu` 状态管理菜单显示
- 添加了 `formatMenuRef` 用于检测点击外部
- 实现了 `handleDownloadFormat` 处理格式选择
- 添加了 `useEffect` 监听点击外部事件

### StorageService 修改
- 修正了 `downloadDocumentFile` 方法中的 URL
- HTML 文件使用 `response.text()` 而不是 `response.json()`
- 更新了下载端点为 `/download/html` 和 `/download/pdf`

### 测试修改
- 更新了 `StorageService.fileops.test.ts` 中的测试
- 修正了 mock response 对象
- 更新了期望的 URL

## 已知限制
1. PDF 动态生成需要后端支持，目前只提示用户
2. 菜单样式可能需要根据设计系统调整
3. 下载进度没有详细的百分比显示

## 下一步
- 测试完整的导出流程（任务 1-7）
- 确保 HTML 和PDF 文件在导出时正确生成
- 验证图片内嵌功能正常工作
